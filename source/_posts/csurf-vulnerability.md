---
title: The csurf vulnerability (from a dev-perspective)
author: Mauricio Matias C.
avatar: mauricio-matias.jpeg
description: The csurf library has insecure design issues. What can we do?
date: 2022-10-03
tags: [Security]
id: csurf-vulnerability
relatedPost: vue-security-best-practices
---

{% image_fw 1.78 "banner.png" "The csurf vulnerability" %}

The `csurf` library is one of the most popular libraries to carry out the task of CSRF protection in the Node ecosystem. The library has 400K downloads per month. So, it is part of many projects. But, it was discovered recently by Adrian Tiron from the Fortbridge Team (you can check out [his write-up](https://fortbridge.co.uk/research/a-csrf-vulnerability-in-the-popular-csurf-package/)). The library has several wrong designs and could be a counterintuitive library to protect us against CSRF attacks.

<!-- toc -->

Let's talk about it. It is well known that some developers base their judgment about the functionality of a library on the number of stars, downloads, or documentation, which in some cases means respect and trust. But it is possible to find some issues even if the library is famous and widely used.

## The library issues

OnÂ [dev-academy.com](http://dev-academy.com/), we encourage you to read theÂ Adrian Tiron [write-up](https://fortbridge.co.uk/research/a-csrf-vulnerability-in-the-popular-csurf-package/) to exploit and understand the vulnerability in depth. But we can keep his summary about the issues' library.

- Secret stored in clear text in the _csrf cookie
- sha1 is deprecated
- No signature checking for cookies by default
- It only validates the header token against the secret

Secrets are secrets! They never will be discovered by anyone and never be a part of a payload sent to the client (users).

sha1 was deprecate in 2011 (many years before). It was used until 2017 as an algorithm for digital signature purposes on browsers like Firefox and Chrome. So its use in 2022 is dangerous.

The rest of the issues reveals the library doesn't have the most accurate implementation of the "Double Submit Cookie" technique recommended by OWASP to fight against CSRF attacks (link [here](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie)). This technique is easy to implement and uses a stateless approach. In the [web security academy](https://websecurity-academy.com/), we have a detailed explanation of the CSRF attacks.

## The source code never lies

As a developer in a backend role, sometimes we delegate the weight of complex mechanisms implementation to popular libraries in the ecosystem. Maybe it resolves the problem and saves a lot of time, but in the process, we can introduce issues and vulnerabilities in our applications. So we have some recommendations (we mentioned some of them in [previous posts](https://dev-academy.com/vue-security-best-practices/)).

The packages are great! But, it has people behind it and needs more of them to create a good one, so the contribution is crucial. Every package could work well, but you don't take this as a source of truth (doubts and multidimensional perspectives are welcome in the contribution ecosystem ðŸ˜ƒ), and the popular package `csurf` is one of the multiple probes of it.

Check out the source code always if it is possible. Maybe take a little or more time than you have to implement functionality, but this practice is a good way to improve your skills and keep your system secure. A usual path for cyber-criminals to take advantage of each package ecosystem is when the dependency installation is underway or when the library wasn't bad designed intentionally.

## Then, what can I do?

In the case of the `csurf` package, the creator decided to deprecate this package, which means we need to search for alternatives or implement the "Double Submit Cookie" technique on our own. So we won't have new versions in the short term.

{% img "csurf_view.png" "csurf package overview" "lazy" %}

We have these recommendations for you:

- Implement one of the [multiple techniques](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html) to mitigate the CSRF vector.
- Find an alternative library on NPM.
- Use this [PoC repository](https://github.com/cr0wg4n/node-anti-csrf) as a guide to replace the csurf library using the [csrf-csrf](https://www.npmjs.com/package/csrf-csrf) library on NPM.

Last week we found the `csrf-csrf` library to replace csurf in express projects. This library is relatively new. It has a modern code implementation and is powered by the Typescript ecosystem.

So we can use it calling the `doubleCsrf` function, as we can see bellow.

```js
import express from 'express';
import { doubleCsrf } from 'csrf-csrf';
import cookieParser from 'cookie-parser';

const app = express();
app.use(express.json());

const {
  invalidCsrfTokenError,
  generateToken,
  doubleCsrfProtection
} = doubleCsrf({
  getSecret: (req) => req.secret,
  secret: CSRF_SECRET, 
  cookieName: CSRF_COOKIE_NAME,
  cookieOptions: { sameSite: false, secure: false, signed: true }, // not ideal for production, development only
  size: 64,
  ignoredMethods: ['GET', 'HEAD', 'OPTIONS'],
});

app.use(cookieParser(COOKIES_SECRET));
```

Once you have the initial configuration according to your need you can use it as a middleware in your routes.

```js
// Error handling, validation error interception
const csrfErrorHandler = (error, req, res, next) => {
  if (error == invalidCsrfTokenError) {
    res.status(403).json({
      error: 'csrf validation error'
    });
  } else {
    next();
  }
};

app.get('/csrf-token', (req, res) => {
  return res.json({
    token: generateToken(res, req)
  });
});

app.post('/protected_endpoint', doubleCsrfProtection, csrfErrorHandler, (req, res) => {
  console.log(req.body);
  res.json({
    protected_endpoint: 'form processed successfully'
  });
});

// Try with a HTTP client (is not protected from a CSRF attack)
app.post('/unprotected_endpoint', (req, res) => {
  console.log(req.body);
  res.json({
    unprotected_endpoint: 'form processed successfully'
  });
});
```

The middleware validates the token in headers and cookies received in the post requests. Use the `csrfErrorHandle` as a csrf error validation interceptor because the default errors are very transparent to the user revealing the complete stack trace.

In the [PoC repository](https://github.com/cr0wg4n/node-anti-csrf), you can play with the html file (client side) and its script to change the validation behavior.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-CSRF Example</title>
</head>
<body>
    <div id="app"></div>
</body>
<script type="module">
    // Don't forget to change the port if the server uses another one.
    const PORT = 3000
    const response = await fetch(`http://127.0.0.1:${PORT}/csrf-token`);
    const { token } = await response.json();
    console.log('the token', token);

    // The csrf cookie was implicit set on the request by the server
    const post = await fetch(`http://127.0.0.1:${PORT}/protected_endpoint`,{
        method: 'POST',
        headers: {
            'x-csrf-token':token, // comment this line to throw an error.
            'Content-Type':'application/json',
        },
        body: JSON.stringify({
            name:'John Doe',
            id:'xasd2312x2Ã±ljkasdas'
        })
    })
    const app = document.getElementById('app');
    const data = JSON.stringify(await post.json());
    app.innerHTML = `<code>${data}</code>`
</script>
</html>
```

## Summary

We won't encourage you to untrust every little package could you have. But, the packages related to authentication, authorization, routing, and user input must be taken seriously.

Take this problem as a challenge to test libraries, form part of the contribution of a single one like `csrf-csrf`, or implement your super secure library!

Goodbye friends. Until another post :D.

> There's no silver bullet!
